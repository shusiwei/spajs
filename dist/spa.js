"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}();!function(e,t,r){return e.spajs?e.spajs:void("function"==typeof define&&define.amd?define(["jquery","wi"],function($,n){return t(e,$,n,r(e))}):"function"==typeof define&&define.cmd?define(function(require,exports,module){module.exports=t(e,require("jquery"),require("wi"),r(e))}):e.SPA=t(e,e.jQuery,e.WI,r(e)))}(window,function(e,$,t,r){var n=e.document,a=e.location,i=e.history,s=e.sessionStorage,o=[/{{#header}}/,/{{header#}}/,/{{#container}}/,/{{container#}}/,/{{#title#}}/,/{{#back#}}/,/{{#forward#}}/,/{{#home#}}/,/{{#title}}/,/{{title#}}/],u=[n.body.style.hasOwnProperty("webkitBackdropFilter")?'<header class="page-header backdrop">':'<header class="page-header">',"</header>",'<div class="page-container">',"</div>",'<span class="page-title">{{=it.TITLE}}</span>','<a data-rel="back" class="icon back"></a>','<a data-rel="forward" class="icon forward"></a>','<a data-rel="home" class="icon home"></a>','<span class="page-title">',"</span>"],l=[u[0]+u[4]+u[5]+u[1]+u[2]+'<div class="app-error"><p class="app-error-desc iconfont i-{{?it.icon}}{{=it.icon}}{{??}}x404{{?}}-bfo">{{=it.desc}}{{?it.refresh===true}}，请<a data-rel="refresh" class="refresh iconfont i-refresh-bfo">刷新重试</a>{{?}}</p></div>'+u[3]],c=function(c,p,d,h){var f=null,v=this,m=Object.keys(d),y=this.storage=h.storage||{},g={},_={},T=function(e){return e&&e.slice(0,p.HASH_LENGTH)===p.HASH_PREFIX},b=function(e){for(var r=[],n=void 0,a=0,i=e.replace(/\r\n\s*/g,"").split("</template>"),s=i.length;a<s;a++){var l=i[a];if(0!==l.length){var c=l.indexOf(">")+1,p=l.slice(c);if(0===a){n=l.slice(0,c).match(/data-title="(.*)"/);for(var d=0,h=o.length;d<h;d++)t.has(p,o[d].source)&&(p=p.replace(o[d],u[d]))}r.push(p)}}return{tpl:r,title:n?n[1]:n}},E=function(e){return void 0!==_[e]&&void 0!==_[e]._tpl},H=function(e,t){var r=void 0;d.hasOwnProperty(e)&&(e=d[e].name);for(var n=0,a=m.length;n<a;n++){var i=d[m[n]];if(i.name===e)if(null===i.param)r=i;else if(i.param&&t)for(var s=0,o=i.param.length,u=o;s<o;s++)if(t.hasOwnProperty(i.param[s])&&0===--u)return i}return r},w=function(e,t,r){if(null===e)return void 0!==r?r:e;var n={};if(void 0!==r)for(var a in r)n[a]=r[a];if(void 0!==t)for(var i in e)t.hasOwnProperty(i)?n[t[i]]=e[i]:n[i]=e[i];else for(var s in e)n[s]=e[s];return n},R=function(e){var r=e.slice(p.HASH_LENGTH).split("?"),n=r[0],a=r[1]?r[1]:"none",i=r[1]?t.query2json(r[1]):p.SEND_HASH?{}:null,s=H(n,i),o={search:a,hash:e,query:i};return p.SEND_HASH===!0&&(i.hash=e),void 0===s?(o.path=n,o.route={uri:null,params:["descriptor",i,{enumerable:!0}],redirect:null,proxy:null,status:1,observer:!1,render:null,templ:null}):(o.path=s.path,o.route={uri:s.uri||null,params:["descriptor",w(i,s.escape,s.preset),{enumerable:!0}],redirect:s.redirect||null,observer:s.observer||!1,templ:s.templ||null,proxy:s.proxy||null,status:s.hasOwnProperty("status")?s.status:1,render:s.render||null}),o},S=function(e){n.title=e||"页面加载中…"},k=function(){var e=null,t=function(t){return null===e||e===t?t:(e.pause(),t)};return function(r){return e=t(r).appendTo(c)}}(),P=function(){var t=n.createElement("div"),r=n.createElement("b"),a=n.createElement("i"),i=t.classList,s=!0,o=function(e){e.preventDefault()},u=function(t){t===!1?(e.addEventListener("scroll",o,!1),n.body.addEventListener("touchmove",o,!1),i.add("animated")):t===!0&&(e.removeEventListener("scroll",o,!1),n.body.removeEventListener("touchmove",o,!1),i.remove("animated"))};return t.className="app-spinner",t.appendChild(r),t.appendChild(a),n.body.appendChild(t),function(e){e!==s&&u(s=e)}}(),A=function(e,t,r){var n=void 0,a=R(e),i=a.path,s=a.search;return _.hasOwnProperty(i)||(_[i]={}),_[i].hasOwnProperty(s)?(n=_[i][s],"pending"===n.prop.status&&(n.prop.status="restore"),"destroy"===n.prop.status?n.create(r):1===t?n.off().destroy().create(r):2===t&&n.route.observer===!0&&n.off().destroy().create(r)):n=_[i][s]=new L(a,r),n},I=function(e,t){k(e),S(t),P(!0),h.onTransition&&h.onTransition(e)},x=this.request=function(e,r,n,o){f&&f.stopRequest(),r=void 0===r?a.hash===e?0:2:r,3===arguments.length&&t.is("object",arguments[2])&&(n=void 0,o=arguments[2]),0===n&&null===s.getItem(p.PROJECT)&&(i.replaceState(null,null,p.HOME_HASH),s.setItem(p.PROJECT,!0),e!==p.HOME_HASH&&i.pushState(null,null,e)),1===r&&i.replaceState(null,null,e),2===r&&i.pushState(null,null,e);var u=f=A(e,void 0===n?1:n,o);if(u.route.redirect){var l=u.route.redirect(u,y);if(l)return D(l)}E(u.path)?null===u.route.uri||"restore"===u.prop.status?u.applyData():u.runtime.dataXHR=u.ajaxData():(null!==u.route.uri&&(u.runtime.dataXHR=u.ajaxData()),u.route.templ?u.applyTpl(u.route.templ).checkRequest():null===u.route.templ&&(u.runtime.tplXHR=u.ajaxTpl()))},D=this.redirect=function(e,r,n){x(e,t.is("number",r)?r:1,n)},O=this.compile=function(e,t){return r.compile(e)($.extend({},t,M()))},M=this.define=function(e,r){switch(arguments.length){case 0:return g;case 1:return g[e];case 2:var n={};return n[e]=["descriptor",r,{enumerable:!0}],t.defineProp(g,n,{})}};M("PROJECT_NAME",p.PROJECT_NAME),M("PROJECT_DIR",p.PROJECT_DIR),M("IMG_DIR",p.IMG_DIR),M("JS_DIR",p.JS_DIR),M("HASH_PREFIX",p.HASH_PREFIX);var L=function(){function r(e,n){_classCallCheck(this,r),t.defineProp(this,e,{runtime:{listen:[],pend:[],destroy:[],callback:["descriptor",null,{writable:!0}],tplXHR:["descriptor",null,{writable:!0}],dataXHR:["descriptor",null,{writable:!0}]},prop:{status:["descriptor",null,{writable:!0}],timer:["descriptor",0,{writable:!0}],count:["descriptor",0,{writable:!0}],scrollY:["descriptor",0,{writable:!0}]}}).create(n)}return _createClass(r,[{key:"create",value:function(e){var t=n.createElement("div");return t.className="app-page",this.state={},this.render=e||null,this.$webview=$(t),this.prop.status="ready",this.prop.timer=0,this.prop.count=0,this.prop.scrollY=0,j.push(this)}},{key:"on",value:function(e){var r=this.runtime;return t.is("function",e.listen)&&(e.listen(),this.route.observer===!1&&r.listen.push(e.listen)),t.is("function",e.pend)&&r.pend.push(e.pend),t.is("function",e.destroy)&&r.destroy.push(e.destroy),this}},{key:"off",value:function(){for(var e=this.runtime,t=e.pend,r=e.listen,n=t.length,a=0;a<n;a++)t[a]();return t.splice(0,n),this.route.observer===!1&&r.splice(0,r.length),this}},{key:"pause",value:function(){for(var t=0,r=this.runtime.pend,n=r.length;t<n;t++)r[t]();return this.prop.status="pending",this.prop.scrollY=e.scrollY,this.prop.count++,this.$webview.detach(),this}},{key:"destroy",value:function(e){for(var t=this.runtime.destroy,r=t.length,n=0;n<r;n++)t[n]();return t.splice(0,r),this.$webview.remove(),this.prop.status="destroy",this.runtime.callback=null,j.remove(this)}},{key:"checkRequest",value:function(){null!==this.runtime.dataXHR&&null!==this.runtime.tplXHR||this.applyData()}},{key:"stopRequest",value:function(e,t,r){if(P(!!e),S(),this.runtime.tplXHR&&this.runtime.tplXHR.abort(),this.runtime.dataXHR&&this.runtime.dataXHR.abort(),e){if(this.render)return this.applyData(l);this.render={desc:e,refresh:r,icon:t},this.applyData(l)}}},{key:"ajaxData",value:function(){var e=this;return $.ajax({url:this.route.uri,type:p.API_TYPE,data:this.route.params?$.extend({},this.route.params,p.API_DATA):p.API_DATA,dataType:p.API_DATA_TYPE,timeout:p.TIME_OUT}).done(function(r){if(t.is("function",e.route.proxy)&&(r=e.route.proxy(r,e,y,D)),void 0===r||null===r||r===!1)return r;if(void 0===r.status)e.stopRequest("返回的数据无status");else if(r.status===(e.route.status||1)){if(0===r.render.status)return e.stopRequest("您访问的页面不存在");e.render=$.extend(e.render,r.render),e.checkRequest()}else e.stopRequest(r.msg||"服务器发生未知错误","debug")}).fail(function(t,r,n){switch(r){case"error":switch(t.status){case 404:e.stopRequest("您访问的页面未找到");break;default:e.stopRequest("服务器发生错误","debug",!0)}break;case"abort":e.stopRequest("页面请求被中止");break;case"timeout":e.stopRequest("您的网络不给力","wifi-error",!0);break;case"parsererror":e.stopRequest("数据格式错误","debug")}}).always(function(){e.runtime.dataXHR=null})}},{key:"applyData",value:function(e){this.templ||t.defineProp(this,{templ:_[this.path]._tpl});var r=this.render=this.render||{},n=this.route.render,a=void 0,i=_[this.path]._title||M("PROJECT_NAME");return"restore"===this.prop.status?I(this,i):(null!==n&&(a=t.is("function",n)?n(r,this,y):n),this.$webview.append(this.compile(e||this.templ[0],a?$.extend(r,a):r,i)),void I(this,i))}},{key:"ajaxTpl",value:function(){var e=this;return $.ajax({url:p.TPL_DIR+this.path+p.TPL_EXT_NAME,type:"GET",dataType:"html",timeout:p.TIME_OUT}).done(function(t){e.applyTpl(t).checkRequest()}).fail(function(t,r){switch(r){case"error":e.stopRequest("您访问的页面不存在");break;case"timeout":e.stopRequest("您的网络不给力","wifi-error",!0)}}).always(function(){e.runtime.tplXHR=null})}},{key:"applyTpl",value:function(e){var t=b(e);return _[this.path]._tpl=t.tpl,_[this.path]._title=t.title,this}},{key:"compile",value:function(e,t,r){return O(e,$.extend({TITLE:r,JS_FILE:this.path+p.JS_EXT_NAME},t))}},{key:"exec",value:function(e){switch(this.prop.status){case"pending":this.runtime.callback=function(){this.runtime.callback=null,e(this,$,t,v)};break;case"ready":case"active":case"restore":e(this,$,t,v)}}},{key:"appendTo",value:function(t){if(this.$webview.appendTo(t),"restore"===this.prop.status){this.runtime.callback&&this.runtime.callback(),e.scrollTo(0,this.prop.scrollY);for(var r=0,n=this.runtime.listen,a=n.length;r<a;r++)n[r]()}else e.scrollTo(0,0);return this.prop.status="active",this.prop.timer=0,this}},{key:"setState",value:function(){if(0===arguments.length)return this.state;if(1===arguments.length&&t.is("string",arguments[0]))return this.state[arguments[0]];if(2===arguments.length&&t.is("string",arguments[0]))this.state[arguments[0]]=arguments[1];else for(var e=0,r=arguments.length;e<r;e++)$.extend(this.state,arguments[0]);return this.state}}]),r}(),j=function(e){var t=4500,r=function(e,r){r&&"pending"===r.prop.status&&(r.prop.timer>=p.AUTO_DIE_TIME+r.prop.count*t?r.off().destroy():r.prop.timer+=t)},n=function(){for(var t=0,n=e.length;t<n;t++)r(t,e[t])};setInterval(n,t);return{push:function(t){return e.push(t),t},remove:function(t){return e.splice(e.indexOf(t),1),t}}}([]);e.spajs={version:"2.7.21",exec:function(e){e(f,$,t,this)}.bind(this)};return e.addEventListener("popstate",function(e){if(a.hash!==f.hash&&T(a.hash))return x(a.hash,0,2)},!1),$(n.body).on("click",'a[href^="'+p.HASH_PREFIX+'"]',function(e){return e.preventDefault(),x(this.getAttribute("href"),this.dataset.state?parseInt(this.dataset.state):void 0)}).on("click","[data-hash]",function(e){return e.preventDefault(),x(p.HASH_PREFIX+this.dataset.hash,this.dataset.state?parseInt(this.dataset.state):void 0)}).on("click","a[data-rel]",function(e){switch(e.preventDefault(),this.dataset.rel){case"back":return i.back();case"forward":return i.forward();case"refresh":return D(a.hash);case"home":return x(p.HOME_HASH)}}),h.onReady&&h.onReady(this),T(a.hash)?x(a.hash,0,0):x(p.HOME_HASH,1),this};return c.config=function(e,r){var n=r.prefix||"#!",a=n.length,i=r.name||e,s=r.version||t.getRandomStamp(),o=r.root?r.root:"./project/",u=r.apiType||"post",l=r.apiDataType||"json",c=r.apiData||{},p=r.timeout||15e3,d=r.sendHash||!1,h=o+(r.imgDir||"img"),f=o+(r.jsDir||"js"),v=o+(r.tplDir||"tpl"),m="{{version}}"===s?".tpl":"-"+s+".tpl",y="{{version}}"===s?".js":"-"+s+".js",g=n+(r.homeHash||"index"),_=r.lifeCycle||9e4;return{PROJECT:e,PROJECT_NAME:i,PROJECT_DIR:o,HASH_PREFIX:n,HASH_LENGTH:a,API_TYPE:u,API_DATA_TYPE:l,API_DATA:c,SEND_HASH:d,IMG_DIR:h,JS_DIR:f,TPL_DIR:v+"/",TPL_EXT_NAME:m,JS_EXT_NAME:y,HOME_HASH:g,TIME_OUT:p,AUTO_DIE_TIME:_}},c.router=function(e){var r=function(r){return t.is("string",r)?0===r.indexOf("http")||0===r.indexOf("//")||0===r.indexOf("/")?r:e+r:null},n=function(e,t){return $.extend({},e,{name:t})},a=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"push",value:function(){for(var e=arguments,a=arguments[0].split("?:"),i=this[arguments[0]]={name:a[0],param:a[1]?a[1].split(":"):null,path:a[1]?arguments[0].replace(/\?/,"/").replace(/:/g,"~"):a[0],uri:null},s=1;s<arguments.length;s++)if(t.is("string",arguments[s]))"<template"===arguments[s].slice(0,9)?i.templ=arguments[s]:t.has(arguments[s],"=")?i.preset=t.query2json(arguments[s]):i.uri=r(arguments[s]);else if(t.is("array",arguments[s]))!function(){var t=i.escape={};e[s].forEach(function(e){var r=e.split(" => ");t[r[1]]=r[0]})}();else if(t.is("object",arguments[s])){var o=arguments[s];if(t.is("function",o.redirect)&&(i.redirect=o.redirect),t.is("boolean",o.observer)&&(i.observer=o.observer),t.is("function",o.proxy)&&(i.proxy=o.proxy),o.hasOwnProperty("status")&&(i.status=o.status),t.is("function",o.render)&&(i.render=o.render),t.is("string",o.alias))this[o.alias]=n(i,o.alias);else if(t.is("array",o.alias))for(var u=0,l=o.alias.length;u<l;u++)this[o.alias[u]]=n(i,o.alias[u])}return this}}]),e}();return new a},c},function(e){function t(e,r,n){return("string"==typeof r?r:r.toString()).replace(e.define||i,function(t,r,a,i){return 0===r.indexOf("def.")&&(r=r.substring(4)),r in n||(":"===a?(e.defineParams&&i.replace(e.defineParams,function(e,t,a){n[r]={arg:t,text:a}}),r in n||(n[r]=i)):new Function("def","def['"+r+"']="+i)(n)),""}).replace(e.use||i,function(r,a){e.useParams&&(a=a.replace(e.useParams,function(e,t,r,a){if(n[r]&&n[r].arg&&a){var i=(r+":"+a).replace(/'|\\/g,"_");return n.__exp=n.__exp||{},n.__exp[i]=n[r].text.replace(new RegExp("(^|[^\\w$])"+n[r].arg+"([^\\w$])","g"),"$1"+a+"$2"),t+"def.__exp['"+i+"']"}}));var i=new Function("def","return "+a)(n);return i?t(e,i,n):i})}function r(e){return e.replace(/\\('|\\)/g,"$1").replace(/[\r\t\n]/g," ")}var n={version:"1.0.3",templateSettings:{evaluate:/\{\{([\s\S]+?(\}?)+)\}\}/g,interpolate:/\{\{=([\s\S]+?)\}\}/g,encode:/\{\{!([\s\S]+?)\}\}/g,use:/\{\{#([\s\S]+?)\}\}/g,useParams:/(^|[^\w$])def(?:\.|\[[\'\"])([\w$\.]+)(?:[\'\"]\])?\s*\:\s*([\w$\.]+|\"[^\"]+\"|\'[^\']+\'|\{[^\}]+\})/g,define:/\{\{##\s*([\w\.$]+)\s*(\:|=)([\s\S]+?)#\}\}/g,defineParams:/^\s*([\w$]+):([\s\S]+)/,conditional:/\{\{\?(\?)?\s*([\s\S]*?)\s*\}\}/g,iterate:/\{\{~\s*(?:\}\}|([\s\S]+?)\s*\:\s*([\w$]+)\s*(?:\:\s*([\w$]+))?\s*\}\})/g,varname:"it",strip:!0,append:!0,selfcontained:!1,doNotSkipEncoded:!1},template:void 0,compile:void 0};n.encodeHTMLSource=function(e){var t={"&":"&#38;","<":"&#60;",">":"&#62;",'"':"&#34;","'":"&#39;","/":"&#47;"},r=e?/[&<>"'\/]/g:/&(?!#?\w+;)|<|>|"|'|\//g;return function(e){return e?e.toString().replace(r,function(e){return t[e]||e}):""}};var a={append:{start:"'+(",end:")+'",startencode:"'+encodeHTML("},split:{start:"';out+=(",end:");out+='",startencode:"';out+=encodeHTML("}},i=/$^/;return n.template=function(s,o,u){o=o||n.templateSettings;var l,c,p=o.append?a.append:a.split,d=0,h=o.use||o.define?t(o,s,u||{}):s;h=("var out='"+(o.strip?h.replace(/(^|\r|\n)\t* +| +\t*(\r|\n|$)/g," ").replace(/\r|\n|\t|\/\*[\s\S]*?\*\//g,""):h).replace(/'|\\/g,"\\$&").replace(o.interpolate||i,function(e,t){return p.start+r(t)+p.end}).replace(o.encode||i,function(e,t){return l=!0,p.startencode+r(t)+p.end}).replace(o.conditional||i,function(e,t,n){return t?n?"';}else if("+r(n)+"){out+='":"';}else{out+='":n?"';if("+r(n)+"){out+='":"';}out+='"}).replace(o.iterate||i,function(e,t,n,a){return t?(d+=1,c=a||"i"+d,t=r(t),"';var arr"+d+"="+t+";if(arr"+d+"){var "+n+","+c+"=-1,l"+d+"=arr"+d+".length-1;while("+c+"<l"+d+"){"+n+"=arr"+d+"["+c+"+=1];out+='"):"';} } out+='"}).replace(o.evaluate||i,function(e,t){return"';"+r(t)+"out+='"})+"';return out;").replace(/\n/g,"\\n").replace(/\t/g,"\\t").replace(/\r/g,"\\r").replace(/(\s|;|\}|^|\{)out\+='';/g,"$1").replace(/\+''/g,""),l&&(o.selfcontained||!e||e._encodeHTML||(e._encodeHTML=n.encodeHTMLSource(o.doNotSkipEncoded)),h="var encodeHTML = typeof _encodeHTML !== 'undefined' ? _encodeHTML : ("+n.encodeHTMLSource.toString()+"("+(o.doNotSkipEncoded||"")+"));"+h);try{return new Function(o.varname,h)}catch(f){throw"undefined"!=typeof console&&console.log("Could not create a template function: "+h),f}},n.compile=function(e,t){return n.template(e,null,t)},n});