"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}();!function(e,t,r){return e.spajs?e.spajs:void("function"==typeof define&&define.amd?define(["jquery"],function($){return t(e,$,r(e))}):"function"==typeof define&&define.cmd?define(function(require,exports,module){module.exports=t(e,require("jquery"),r(e))}):e.SPA=t(e,e.jQuery,r(e)))}(window,function(e,$,t){var r=function(e,t){var r=Object.prototype.toString.call(t).toLowerCase().slice(8,-1);switch(e){case"undefined":return void 0===t;case"null":return null===t;case"object":return t&&r===e;case"number":case"array":case"string":case"function":case"boolean":return r===e;default:return!1}},n=function(){return r("object",arguments[0])},a=function(){return r("number",arguments[0])},i=function(){return r("array",arguments[0])},s=function(){return r("string",arguments[0])},o=function(){return r("function",arguments[0])},u=function(){return r("boolean",arguments[0])},l=function(){return arguments[0].indexOf(arguments[1])>-1},c=function(){var e=function(e){var t={};for(var r in e[1])Object.defineProperty(t,r,$.extend({value:e[1][r]},e[2]));return{value:t}};return function(t){for(var r=1,a=arguments.length;r<a;r++)for(var s in arguments[r]){var o=void 0;o=n(arguments[r][s])?{value:c({},arguments[r][s])}:i(arguments[r][s])&&3===arguments[r][s].length&&"descriptor"===arguments[r][s][0]?n(arguments[r][s][1])?e(arguments[r][s]):$.extend({value:arguments[r][s][1]},arguments[r][s][2]):{value:arguments[r][s]},Object.defineProperty(t,s,o)}return t}}(),p=function(){var t=e.location.search.split("?").pop(),r=void 0;switch(arguments.length){case 1:s(arguments[0])&&l(arguments[0],"=")?t=arguments[0]:(i(arguments[0])||s(arguments[0])&&!l(arguments[0],"="))&&(r=arguments[0]);break;case 2:t=arguments[0],r=arguments[1]}if(!t||!l(t,"="))return null;var n=c({},{length:["descriptor",0,{writable:!0}]});return $.each(t.split("&"),function(e,t){var r=t.split("=");2===r.length&&(n[r[0]]=r[1],n.length++)}),s(r)?n[r]:i(r)?function(e,t){return $.each(e,function(e,r){t[r]=n[r],t.length++}),t}(r,c({},{length:["descriptor",0,{writable:!0}]})):void 0===r?n:void 0},d=function(e){return function(t,r){t=t||16;for(var n=e.length,a="",i=0;i<t;i++){var s=e[Math.floor(Math.random()*n)];if(r)a+=s;else for(;a.indexOf(s)===-1;)a+=s}return a}}([0,1,2,3,4,5,6,7,8,9,"a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"]),h=function f(r,i,u,d){var h=null,v=e.document,m=e.location,g=e.history,y=e.sessionStorage,b=[/{{#header}}/,/{{header#}}/,/{{#container}}/,/{{container#}}/,/{{#title#}}/,/{{#back#}}/,/{{#forward#}}/,/{{#home#}}/,/{{#title}}/,/{{title#}}/],_=[v.body.style.hasOwnProperty("webkitBackdropFilter")?'<header class="page-header backdrop">':'<header class="page-header">',"</header>",'<div class="page-container">',"</div>",'<span class="page-title">{{=it.TITLE}}</span>','<a data-rel="back" class="app-ui-icon app-icon-back icon back"></a>','<a data-rel="forward" class="app-ui-icon app-icon-forward icon forward"></a>','<a data-rel="home" class="app-ui-icon app-icon-home icon home"></a>','<span class="page-title">',"</span>"],w=[_[0]+_[4]+_[5]+_[1]+_[2]+'<div class="app-error"><p class="app-error-desc app-ui-icon app-icon-{{?it.icon}}{{=it.icon}}{{??}}x404{{?}}">{{=it.desc}}{{?it.refresh===true}}，请<a data-rel="refresh" class="refresh app-ui-icon app-icon-refresh">刷新重试</a>{{?}}</p></div>'+_[3]],T=Object.keys(u),E={},H={},k=function(e){return e&&e.slice(0,i.HASH_LENGTH)===i.HASH_PREFIX},R=function(e){for(var t=[],r=void 0,n=0,a=e.replace(/\r\n\s*/g,"").split("</template>"),i=a.length;n<i;n++){var s=a[n];if(0!==s.length){var o=s.indexOf(">")+1,u=s.slice(o);if(0===n){r=s.slice(0,o).match(/data-title="(.*)"/);for(var c=0,p=b.length;c<p;c++)l(u,b[c].source)&&(u=u.replace(b[c],_[c]))}t.push(u)}}return{tpl:t,title:r?r[1]:r}},S=function(e){return void 0!==H[e]&&void 0!==H[e]._tpl},P=function(e,t){var r=void 0;u.hasOwnProperty(e)&&(e=u[e].name);for(var n=0,a=T.length;n<a;n++){var i=u[T[n]];if(i.name===e)if(null===i.param)r=i;else if(i.param&&t)for(var s=0,o=i.param.length,l=o;s<o;s++)if(t.hasOwnProperty(i.param[s])&&0===--l)return i}return r},A=function(e,t,r){if(null===e)return void 0!==r?r:e;var n={};if(void 0!==r)for(var a in r)n[a]=r[a];if(void 0!==t)for(var i in e)t.hasOwnProperty(i)?n[t[i]]=e[i]:n[i]=e[i];else for(var s in e)n[s]=e[s];return n},x=function(e){var t=e.slice(i.HASH_LENGTH).split("?"),r=t[0],n=t[1]?t[1]:"none",a=t[1]?p(t[1]):i.SEND_HASH?{}:null,s=P(r,a),o={search:n,hash:e,query:a};return i.SEND_HASH===!0&&(a.hash=e),void 0===s?(o.path=r,o.route={uri:null,params:["descriptor",a,{enumerable:!0}],redirect:null,proxy:null,status:1,observer:!1,render:null,templ:null}):(o.path=s.path,o.route={uri:s.uri||null,params:["descriptor",A(a,s.escape,s.preset),{enumerable:!0}],redirect:s.redirect||null,observer:s.observer||!1,templ:s.templ||null,proxy:s.proxy||null,status:s.hasOwnProperty("status")?s.status:1,render:s.render||null}),o},I=function(e){v.title=e||"页面加载中…"},O=function(){var e=null,t=function(t){return null===e||e===t?t:(e.pause(),t)};return function(n){return e=t(n).appendTo(r)}}(),D=function(){var t=v.createElement("div"),r=v.createElement("b"),n=v.createElement("i"),a=t.classList,i=!0,s=function(e){e.preventDefault()},o=function(t){t===!1?(e.addEventListener("scroll",s,!1),v.body.addEventListener("touchmove",s,!1),a.add("animated")):t===!0&&(e.removeEventListener("scroll",s,!1),v.body.removeEventListener("touchmove",s,!1),a.remove("animated"))};return t.className="app-spinner",t.appendChild(r),t.appendChild(n),v.body.appendChild(t),function(e){e!==i&&o(i=e)}}(),M=function(e,t){O(e),I(t),D(!0),d.onTransition&&d.onTransition(e)},f=function(){function r(){_classCallCheck(this,r);var t=this;if(n(d.storage))for(var a in d.storage)this[a]=d.storage[a];this.define("PROJECT_NAME",i.PROJECT_NAME),this.define("PROJECT_DIR",i.PROJECT_DIR),this.define("IMG_DIR",i.IMG_DIR),this.define("JS_DIR",i.JS_DIR),this.define("HASH_PREFIX",i.HASH_PREFIX),e.addEventListener("popstate",function(e){if(m.hash!==h.hash&&k(m.hash))return t.request(m.hash,0,2)},!1),$(v.body).on("click",'a[href^="'+i.HASH_PREFIX+'"]',function(e){return e.preventDefault(),t.request(this.getAttribute("href"),this.dataset.state?parseInt(this.dataset.state):void 0)}).on("click","[data-hash]",function(e){return e.preventDefault(),t.request(i.HASH_PREFIX+this.dataset.hash,this.dataset.state?parseInt(this.dataset.state):void 0)}).on("click","a[data-rel]",function(e){switch(e.preventDefault(),this.dataset.rel){case"back":return g.back();case"forward":return g.forward();case"refresh":return t.redirect(m.hash);case"home":return t.request(i.HOME_HASH)}}),d.onReady&&d.onReady(this),k(m.hash)?this.request(m.hash,0,0):this.request(i.HOME_HASH,1)}return _createClass(r,[{key:"request",value:function(e,t,r,a){h&&h.stopRequest(),t=void 0===t?m.hash===e?0:2:t,3===arguments.length&&n(arguments[2])&&(r=void 0,a=arguments[2]),0===r&&null===y.getItem(i.PROJECT)&&(g.replaceState(null,null,i.HOME_HASH),y.setItem(i.PROJECT,!0),e!==i.HOME_HASH&&g.pushState(null,null,e)),1===t&&g.replaceState(null,null,e),2===t&&g.pushState(null,null,e);var s=h=this.getWebView(e,void 0===r?1:r,a);if(s.route.redirect){var o=s.route.redirect(s,this);if(o)return this.redirect(o)}S(s.path)?null===s.route.uri||"restore"===s.prop.status?s.applyData():s.runtime.dataXHR=s.ajaxData():(null!==s.route.uri&&(s.runtime.dataXHR=s.ajaxData()),s.route.templ?s.applyTpl(s.route.templ).checkRequest():null===s.route.templ&&(s.runtime.tplXHR=s.ajaxTpl()))}},{key:"redirect",value:function(e,t,r){this.request(e,a(t)?t:1,r)}},{key:"compile",value:function(e,r){return t.compile(e)($.extend({},r,this.define()))}},{key:"define",value:function(e,t){switch(arguments.length){case 0:return E;case 1:return E[e];case 2:var r={};return r[e]=["descriptor",t,{enumerable:!0}],c(E,r,{})}}},{key:"getWebView",value:function(e,t,r){var n=void 0,a=x(e),i=a.path,s=a.search;return H.hasOwnProperty(i)||(H[i]={}),H[i].hasOwnProperty(s)?(n=H[i][s],"pending"===n.prop.status&&(n.prop.status="restore"),"destroy"===n.prop.status?n.create(r):1===t?n.off().destroy().create(r):2===t&&n.route.observer===!0&&n.off().destroy().create(r)):n=H[i][s]=new C(a,r,this),n}}]),r}(),C=function(){function t(e,r){_classCallCheck(this,t),c(this,e,{runtime:{listen:[],pend:[],destroy:[],callback:["descriptor",null,{writable:!0}],tplXHR:["descriptor",null,{writable:!0}],dataXHR:["descriptor",null,{writable:!0}]},prop:{status:["descriptor",null,{writable:!0}],timer:["descriptor",0,{writable:!0}],count:["descriptor",0,{writable:!0}],scrollY:["descriptor",0,{writable:!0}]}}).create(r)}return _createClass(t,[{key:"create",value:function(e){var t=v.createElement("div");return t.className="app-page",this.state={},this.render=e||null,this.$webview=$(t),this.prop.status="ready",this.prop.timer=0,this.prop.count=0,this.prop.scrollY=0,q.push(this)}},{key:"on",value:function(e){var t=this.runtime;return o(e.listen)&&(e.listen(),this.route.observer===!1&&t.listen.push(e.listen)),o(e.pend)&&t.pend.push(e.pend),o(e.destroy)&&t.destroy.push(e.destroy),this}},{key:"off",value:function(){for(var e=this.runtime,t=e.pend,r=e.listen,n=t.length,a=0;a<n;a++)t[a]();return t.splice(0,n),this.route.observer===!1&&r.splice(0,r.length),this}},{key:"pause",value:function(){for(var t=0,r=this.runtime.pend,n=r.length;t<n;t++)r[t]();return this.prop.status="pending",this.prop.scrollY=e.scrollY,this.prop.count++,this.$webview.detach(),this}},{key:"destroy",value:function(e){for(var t=this.runtime.destroy,r=t.length,n=0;n<r;n++)t[n]();return t.splice(0,r),this.$webview.remove(),this.prop.status="destroy",this.runtime.callback=null,q.remove(this)}},{key:"checkRequest",value:function(){null!==this.runtime.dataXHR&&null!==this.runtime.tplXHR||this.applyData()}},{key:"stopRequest",value:function(e,t,r){if(D(!!e),I(),this.runtime.tplXHR&&this.runtime.tplXHR.abort(),this.runtime.dataXHR&&this.runtime.dataXHR.abort(),e){if(this.render)return this.applyData(w);this.render={desc:e,refresh:r,icon:t},this.applyData(w)}}},{key:"ajaxData",value:function(){var e=this;return $.ajax({url:this.route.uri,type:i.API_TYPE,data:this.route.params?$.extend({},this.route.params,i.API_DATA):i.API_DATA,dataType:i.API_DATA_TYPE,timeout:i.TIME_OUT}).done(function(t){if(o(e.route.proxy)&&(t=e.route.proxy(t,e,L)),void 0===t||null===t||t===!1)return t;if(void 0===t.status)e.stopRequest("返回的数据无status");else if(t.status===(e.route.status||1)){if(0===t.render.status)return e.stopRequest("您访问的页面不存在");e.render=$.extend(e.render,t.render),e.checkRequest()}else e.stopRequest(t.msg||"服务器发生未知错误","debug")}).fail(function(t,r,n){switch(r){case"error":switch(t.status){case 404:e.stopRequest("您访问的页面未找到");break;default:e.stopRequest("服务器发生错误","debug",!0)}break;case"abort":e.stopRequest("页面请求被中止");break;case"timeout":e.stopRequest("您的网络不给力","wifi-error",!0);break;case"parsererror":e.stopRequest("数据格式错误","debug")}}).always(function(){e.runtime.dataXHR=null})}},{key:"applyData",value:function(e){this.templ||c(this,{templ:H[this.path]._tpl});var t=this.render=this.render||{},r=this.route.render,n=void 0,a=H[this.path]._title||L.define("PROJECT_NAME");return"restore"===this.prop.status?M(this,a):(null!==r&&(n=o(r)?r(t,this,L):r),this.$webview.append(this.compile(e||this.templ[0],n?$.extend(t,n):t,a)),void M(this,a))}},{key:"ajaxTpl",value:function(){var e=this;return $.ajax({url:i.TPL_DIR+this.path+i.TPL_EXT_NAME,type:"GET",dataType:"html",timeout:i.TIME_OUT}).done(function(t){e.applyTpl(t).checkRequest()}).fail(function(t,r){switch(r){case"error":e.stopRequest("您访问的页面不存在");break;case"timeout":e.stopRequest("您的网络不给力","wifi-error",!0)}}).always(function(){e.runtime.tplXHR=null})}},{key:"applyTpl",value:function(e){var t=R(e);return H[this.path]._tpl=t.tpl,H[this.path]._title=t.title,this}},{key:"compile",value:function(e,t,r){return L.compile(e,$.extend({TITLE:r,JS_FILE:this.path+i.JS_EXT_NAME},t))}},{key:"exec",value:function(e){switch(this.prop.status){case"pending":this.runtime.callback=function(){this.runtime.callback=null,e.bind(L,this,this.$webview,this.state)};break;case"ready":case"active":case"restore":e.bind(L,this,this.$webview,this.state)}}},{key:"appendTo",value:function(t){if(this.$webview.appendTo(t),"restore"===this.prop.status){this.runtime.callback&&this.runtime.callback(),e.scrollTo(0,this.prop.scrollY);for(var r=0,n=this.runtime.listen,a=n.length;r<a;r++)n[r]()}else e.scrollTo(0,0);return this.prop.status="active",this.prop.timer=0,this}},{key:"setState",value:function(){if(0===arguments.length)return this.state;if(1===arguments.length&&s(arguments[0]))return this.state[arguments[0]];if(2===arguments.length&&s(arguments[0]))this.state[arguments[0]]=arguments[1];else for(var e=0,t=arguments.length;e<t;e++)$.extend(this.state,arguments[0]);return this.state}}]),t}(),q=function(e){var t=4500,r=function(e,r){r&&"pending"===r.prop.status&&(r.prop.timer>=i.AUTO_DIE_TIME+r.prop.count*t?r.off().destroy():r.prop.timer+=t)},n=function(){for(var t=0,n=e.length;t<n;t++)r(t,e[t])};setInterval(n,t);return{push:function(t){return e.push(t),t},remove:function(t){return e.splice(e.indexOf(t),1),t}}}([]),L=(e.spajs={version:"2.7.21",exec:function(e){e(h)}},new f);return L};return h.config=function(e,t){var r=t.prefix||"#!",n=r.length,a=t.name||e,i=t.version||d(),s=t.root?t.root:"./project/",o=t.apiType||"post",u=t.apiDataType||"json",l=t.apiData||{},c=t.timeout||15e3,p=t.sendHash||!1,h=s+(t.imgDir||"img"),f=s+(t.jsDir||"js"),v=s+(t.tplDir||"tpl"),m="{{version}}"===i?".tpl":"-"+i+".tpl",g="{{version}}"===i?".js":"-"+i+".js",y=r+(t.homeHash||"index"),b=t.lifeCycle||9e4;return{PROJECT:e,PROJECT_NAME:a,PROJECT_DIR:s,HASH_PREFIX:r,HASH_LENGTH:n,API_TYPE:o,API_DATA_TYPE:u,API_DATA:l,SEND_HASH:p,IMG_DIR:h,JS_DIR:f,TPL_DIR:v+"/",TPL_EXT_NAME:m,JS_EXT_NAME:g,HOME_HASH:y,TIME_OUT:c,AUTO_DIE_TIME:b}},h.router=function(e){var t=function(t){return s(t)?0===t.indexOf("http")||0===t.indexOf("//")||0===t.indexOf("/")?t:e+t:null},r=function(e,t){return $.extend({},e,{name:t})},a=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"push",value:function(){for(var e=arguments,a=arguments[0].split("?:"),c=this[arguments[0]]={name:a[0],param:a[1]?a[1].split(":"):null,path:a[1]?arguments[0].replace(/\?/,"/").replace(/:/g,"~"):a[0],uri:null},d=1;d<arguments.length;d++)if(s(arguments[d]))"<template"===arguments[d].slice(0,9)?c.templ=arguments[d]:l(arguments[d],"=")?c.preset=p(arguments[d]):c.uri=t(arguments[d]);else if(i(arguments[d]))!function(){var t=c.escape={};e[d].forEach(function(e){var r=e.split(" => ");t[r[1]]=r[0]})}();else if(n(arguments[d])){var h=arguments[d];if(o(h.redirect)&&(c.redirect=h.redirect),u(h.observer)&&(c.observer=h.observer),o(h.proxy)&&(c.proxy=h.proxy),h.hasOwnProperty("status")&&(c.status=h.status),o(h.render)&&(c.render=h.render),s(h.alias))this[h.alias]=r(c,h.alias);else if(i(h.alias))for(var f=0,v=h.alias.length;f<v;f++)this[h.alias[f]]=r(c,h.alias[f])}return this}}]),e}();return new a},h},function(e){function t(e,r,n){return("string"==typeof r?r:r.toString()).replace(e.define||i,function(t,r,a,i){return 0===r.indexOf("def.")&&(r=r.substring(4)),r in n||(":"===a?(e.defineParams&&i.replace(e.defineParams,function(e,t,a){n[r]={arg:t,text:a}}),r in n||(n[r]=i)):new Function("def","def['"+r+"']="+i)(n)),""}).replace(e.use||i,function(r,a){e.useParams&&(a=a.replace(e.useParams,function(e,t,r,a){if(n[r]&&n[r].arg&&a){var i=(r+":"+a).replace(/'|\\/g,"_");return n.__exp=n.__exp||{},n.__exp[i]=n[r].text.replace(new RegExp("(^|[^\\w$])"+n[r].arg+"([^\\w$])","g"),"$1"+a+"$2"),t+"def.__exp['"+i+"']"}}));var i=new Function("def","return "+a)(n);return i?t(e,i,n):i})}function r(e){return e.replace(/\\('|\\)/g,"$1").replace(/[\r\t\n]/g," ")}var n={version:"1.0.3",templateSettings:{evaluate:/\{\{([\s\S]+?(\}?)+)\}\}/g,interpolate:/\{\{=([\s\S]+?)\}\}/g,encode:/\{\{!([\s\S]+?)\}\}/g,use:/\{\{#([\s\S]+?)\}\}/g,useParams:/(^|[^\w$])def(?:\.|\[[\'\"])([\w$\.]+)(?:[\'\"]\])?\s*\:\s*([\w$\.]+|\"[^\"]+\"|\'[^\']+\'|\{[^\}]+\})/g,define:/\{\{##\s*([\w\.$]+)\s*(\:|=)([\s\S]+?)#\}\}/g,defineParams:/^\s*([\w$]+):([\s\S]+)/,conditional:/\{\{\?(\?)?\s*([\s\S]*?)\s*\}\}/g,iterate:/\{\{~\s*(?:\}\}|([\s\S]+?)\s*\:\s*([\w$]+)\s*(?:\:\s*([\w$]+))?\s*\}\})/g,varname:"it",strip:!0,append:!0,selfcontained:!1,doNotSkipEncoded:!1},template:void 0,compile:void 0};n.encodeHTMLSource=function(e){var t={"&":"&#38;","<":"&#60;",">":"&#62;",'"':"&#34;","'":"&#39;","/":"&#47;"},r=e?/[&<>"'\/]/g:/&(?!#?\w+;)|<|>|"|'|\//g;return function(e){return e?e.toString().replace(r,function(e){return t[e]||e}):""}};var a={append:{start:"'+(",end:")+'",startencode:"'+encodeHTML("},split:{start:"';out+=(",end:");out+='",startencode:"';out+=encodeHTML("}},i=/$^/;return n.template=function(s,o,u){o=o||n.templateSettings;var l,c,p=o.append?a.append:a.split,d=0,h=o.use||o.define?t(o,s,u||{}):s;h=("var out='"+(o.strip?h.replace(/(^|\r|\n)\t* +| +\t*(\r|\n|$)/g," ").replace(/\r|\n|\t|\/\*[\s\S]*?\*\//g,""):h).replace(/'|\\/g,"\\$&").replace(o.interpolate||i,function(e,t){return p.start+r(t)+p.end}).replace(o.encode||i,function(e,t){return l=!0,p.startencode+r(t)+p.end}).replace(o.conditional||i,function(e,t,n){return t?n?"';}else if("+r(n)+"){out+='":"';}else{out+='":n?"';if("+r(n)+"){out+='":"';}out+='"}).replace(o.iterate||i,function(e,t,n,a){return t?(d+=1,c=a||"i"+d,t=r(t),"';var arr"+d+"="+t+";if(arr"+d+"){var "+n+","+c+"=-1,l"+d+"=arr"+d+".length-1;while("+c+"<l"+d+"){"+n+"=arr"+d+"["+c+"+=1];out+='"):"';} } out+='"}).replace(o.evaluate||i,function(e,t){return"';"+r(t)+"out+='"})+"';return out;").replace(/\n/g,"\\n").replace(/\t/g,"\\t").replace(/\r/g,"\\r").replace(/(\s|;|\}|^|\{)out\+='';/g,"$1").replace(/\+''/g,""),l&&(o.selfcontained||!e||e._encodeHTML||(e._encodeHTML=n.encodeHTMLSource(o.doNotSkipEncoded)),h="var encodeHTML = typeof _encodeHTML !== 'undefined' ? _encodeHTML : ("+n.encodeHTMLSource.toString()+"("+(o.doNotSkipEncoded||"")+"));"+h);try{return new Function(o.varname,h)}catch(f){throw"undefined"!=typeof console&&console.log("Could not create a template function: "+h),f}},n.compile=function(e,t){return n.template(e,null,t)},n});